# 規格文件：i18n MCP 翻譯器 - 現有功能

**版本：** 1.2.2
**狀態：** 已實作
**最後更新：** 2025-11-05

## 1. 功能名稱

**i18n MCP 翻譯器** - 自動化 i18n 翻譯與翻譯工作流程管理的完整 MCP 伺服器

## 2. 問題陳述

### 原始問題
軟體專案中的硬編碼文字在進行國際化時面臨重大挑戰：

1. **手動翻譯負擔**：開發人員必須手動識別原始檔案中的所有硬編碼文字
2. **金鑰產生複雜性**：建立具有脈絡意義的 i18n 金鑰耗時且容易出錯
3. **多語言管理**：為多種語言產生翻譯需要呼叫多個服務的 API
4. **程式碼重構風險**：用 i18n 金鑰替換硬編碼文字可能引入語法錯誤
5. **翻譯審核工作流程**：缺乏標準化方式來匯出翻譯供利益相關者審核並重新匯入已核准的變更
6. **檔案結構彈性**：不同專案使用不同的 i18n 檔案結構（巢狀、扁平、每語言檔案）
7. **團隊協作**：難以追蹤分支或版本之間的翻譯變更

### 解決方案範圍
一個 MCP（Model Context Protocol）伺服器，可以：
- 自動偵測原始檔案中的硬編碼文字
- 使用 AI 產生具有脈絡的 i18n 金鑰
- 在一次操作中產生多語言翻譯
- 透過將文字替換為金鑰來安全重構程式碼
- 管理翻譯檔案工作流程（匯出、審核、合併）
- 支援多種 i18n 檔案結構並自動偵測
- 整合 git 以進行版本控制工作流程

## 3. 提議解決方案

包含 7 個主要工具的完整 MCP 伺服器，分為三個類別：

### A. 核心翻譯工具
1. **translate-file**：翻譯包含硬編碼文字的單一原始檔案
2. **enhanced_translate_file**：具有快取和最佳化的增強版本
3. **batch_translate_files**：平行執行的批次處理多個檔案

### B. 翻譯工作流程工具
4. **generate_locale_diff**：產生比較分支變更的差異檔案供團隊審核
5. **merge_translations**：將已審核的翻譯合併回專案檔案
6. **cleanup_diff_directory**：清理暫存差異目錄

### C. Git 整合工具
7. **git_commit_push**：i18n 工作流程的獨立 git 操作

### 技術方法
- **MCP 協定**：適用於 Claude Desktop 和其他 MCP 客戶端的標準 STDIO 傳輸
- **AST 解析**：Babel 解析器用於安全、精確的程式碼轉換
- **AI 整合**：Google Gemini 用於脈絡金鑰產生和翻譯
- **語言探索**：從現有檔案自動偵測已配置的語言
- **檔案格式支援**：支援舊版（巢狀）和現代（每語言）結構

## 4. 需求

### 4.1 功能需求

#### FR1：原始碼翻譯
- **FR1.1**：偵測 JavaScript/TypeScript 檔案中的硬編碼繁體中文文字
- **FR1.2**：同時支援 `t()` 函數呼叫和 `<Trans>` JSX 元件
- **FR1.3**：以點分格式產生具有脈絡的 i18n 金鑰（例如：`result.display.timing`）
- **FR1.4**：翻譯為多種目標語言（英文、日文、簡體中文等）
- **FR1.5**：在原始碼中用 i18n 金鑰替換硬編碼文字
- **FR1.6**：使用新翻譯更新語言 JSON 檔案
- **FR1.7**：返回格式正確的重構程式碼（Prettier 整合）

#### FR2：翻譯檔案管理
- **FR2.1**：支援舊版檔案結構：`{"zh-TW": {"translation": {"key": "value"}}}`
- **FR2.2**：支援現代結構：每語言的獨立檔案（例如：`zh-TW.json`、`en-US.json`）
- **FR2.3**：支援子目錄結構（例如：`client/zh-TW.json`、`editor/zh-TW.json`）
- **FR2.4**：從現有檔案自動偵測檔案結構
- **FR2.5**：根據需要建立新的翻譯檔案/結構
- **FR2.6**：保留現有翻譯和格式

#### FR3：語言探索與配置
- **FR3.1**：從現有翻譯檔案自動探索語言
- **FR3.2**：支援 100+ 種語言代碼及完整元資料（名稱、地區等）
- **FR3.3**：透過環境變數接受語言配置
- **FR3.4**：透過 CLI 參數接受語言配置
- **FR3.5**：配置缺少時回退至合理的預設值

#### FR4：分支比較與差異產生
- **FR4.1**：比較目前分支與 master/main 分支
- **FR4.2**：自動偵測儲存庫使用 master 還是 main
- **FR4.3**：使用 git diff 識別新增、修改和刪除的金鑰
- **FR4.4**：為所有語言變體產生差異檔案
- **FR4.5**：在一次操作中支援多個子目錄
- **FR4.6**：在差異輸出中保留子目錄結構
- **FR4.7**：主語言顯示實際變更，其他語言顯示現有翻譯或空字串
- **FR4.8**：可選的預覽模式（dry-run）
- **FR4.9**：可選的自動提交產生的差異檔案
- **FR4.10**：可選的自動推送至遠端分支

#### FR5：翻譯合併工作流程
- **FR5.1**：按語言代碼配對已審核的翻譯檔案
- **FR5.2**：僅合併已變更的翻譯（保留未變更的金鑰）
- **FR5.3**：從已審核檔案中新增新金鑰
- **FR5.4**：使用新值更新現有金鑰
- **FR5.5**：報告詳細統計資料（新增、更新、未變更）
- **FR5.6**：支援預覽變更的 dry-run 模式
- **FR5.7**：支援詳細記錄的 verbose 模式
- **FR5.8**：可選的在合併後自動清理差異目錄
- **FR5.9**：可選的自動提交合併的檔案
- **FR5.10**：可選的自動推送至遠端分支

#### FR6：Git 整合
- **FR6.1**：提交特定檔案或所有已暫存檔案
- **FR6.2**：產生標準化的 i18n 提交訊息
- **FR6.3**：支援自訂提交訊息
- **FR6.4**：推送提交至遠端儲存庫
- **FR6.5**：自動偵測目前分支或使用指定分支
- **FR6.6**：預覽 git 操作的 dry-run 模式
- **FR6.7**：git 失敗的完整錯誤處理

#### FR7：增強翻譯功能
- **FR7.1**：翻譯結果的智慧快取
- **FR7.2**：平行執行的批次處理
- **FR7.3**：長時間操作的進度報告
- **FR7.4**：強制重新整理選項以覆寫快取
- **FR7.5**：可配置的並行限制

### 4.2 非功能需求

#### NFR1：效能
- **NFR1.1**：處理典型原始檔案（<1000 行）在 <5 秒內完成
- **NFR1.2**：支援批次操作的平行處理
- **NFR1.3**：快取翻譯結果以避免重複的 AI 呼叫
- **NFR1.4**：最小化檔案 I/O 操作

#### NFR2：可靠性
- **NFR2.1**：優雅地處理 AI 服務失敗（使用模擬資料作為回退）
- **NFR2.2**：操作前驗證檔案路徑和權限
- **NFR2.3**：提供詳細的錯誤訊息及可操作的建議
- **NFR2.4**：絕不損壞現有翻譯檔案
- **NFR2.5**：原子檔案操作（寫入暫存檔案，然後重新命名）

#### NFR3：可用性
- **NFR3.1**：最小化所需配置（優先自動偵測）
- **NFR3.2**：提供清晰、可操作的錯誤訊息
- **NFR3.3**：同時支援 CLI 和環境變數配置
- **NFR3.4**：所有破壞性操作的 dry-run 模式
- **NFR3.5**：用於除錯的詳細記錄選項

#### NFR4：可維護性
- **NFR4.1**：TypeScript 嚴格模式和明確類型
- **NFR4.2**：ESM 模組結構
- **NFR4.3**：完整的內聯文件
- **NFR4.4**：模組化架構，關注點清晰分離
- **NFR4.5**：嚴格遵循 MCP 協定規範

#### NFR5：相容性
- **NFR5.1**：Node.js v22.0.0 或更高版本
- **NFR5.2**：與 Claude Desktop 和其他 MCP 客戶端相容
- **NFR5.3**：跨平台支援（Windows、macOS、Linux）
- **NFR5.4**：同時支援舊版和現代 i18n 檔案結構

### 4.3 相依性

#### 外部相依性
- **@modelcontextprotocol/sdk** (^1.13.2)：MCP 協定實作
- **@google/generative-ai** (^0.24.1)：Google Gemini AI 整合
- **@babel/parser** (^7.27.5)：JavaScript/TypeScript AST 解析
- **@babel/traverse** (^7.27.4)：AST 遍歷
- **@babel/generator** (^7.27.5)：從 AST 產生程式碼
- **prettier** (^3.6.1)：轉換後的程式碼格式化
- **zod** (^3.25.67)：MCP 工具的架構驗證
- **commander** (^14.0.0)：CLI 參數解析
- **chalk** (^5.4.1)：終端輸出樣式
- **glob** (^11.0.3)：檔案模式配對
- **dotenv** (^16.6.0)：環境變數管理

#### 系統相依性
- **Node.js**：v22.0.0 或更高版本
- **git**：用於分支比較和 git 操作
- **GOOGLE_AI_API_KEY**：AI 翻譯所需（可選，回退至模擬）

## 5. 技術設計

### 5.1 架構概述

```
┌─────────────────────────────────────────────────────────────┐
│                  MCP 客戶端 (Claude Desktop)                 │
└─────────────────────────┬───────────────────────────────────┘
                          │ STDIO 傳輸
┌─────────────────────────▼───────────────────────────────────┐
│                      MCP 伺服器層                            │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  mcp-server.ts (主伺服器)                            │  │
│  │  - STDIO 傳輸                                        │  │
│  │  - 工具註冊                                          │  │
│  │  - 請求/回應處理                                     │  │
│  └──────────────────┬───────────────────────────────────┘  │
│                     │                                        │
│  ┌──────────────────▼───────────────────────────────────┐  │
│  │  mcp-tools.ts (工具註冊表)                           │  │
│  │  - 使用 Zod 架構的工具定義                           │  │
│  │  - 參數驗證                                          │  │
│  │  - 工具處理器路由                                    │  │
│  └──────────────────┬───────────────────────────────────┘  │
└───────────────────────┼──────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
┌───────▼─────┐  ┌──────▼──────┐  ┌────▼─────────┐
│   翻譯      │  │   工作流程  │  │     Git      │
│   工具      │  │    工具     │  │    工具      │
└───────┬─────┘  └──────┬──────┘  └────┬─────────┘
        │               │               │
┌───────▼─────────────────────────────────────────────────────┐
│                     核心服務層                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │file-processor│  │  ai-service  │  │ lang-manager │     │
│  │  (Babel AST) │  │   (Gemini)   │  │  (JSON I/O)  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│  ┌──────────────┐  ┌──────────────────────────────────┐   │
│  │   language-  │  │  translation-config-service      │   │
│  │discovery-svc │  │  (配置管理)                      │   │
│  └──────────────┘  └──────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
┌───────▼─────┐  ┌──────▼──────┐  ┌────▼─────────┐
│  原始檔案   │  │   翻譯      │  │     Git      │
│ (.ts,.js)   │  │   檔案      │  │   儲存庫     │
│             │  │  (.json)    │  │              │
└─────────────┘  └─────────────┘  └──────────────┘
```

### 5.2 核心元件

#### 5.2.1 MCP 伺服器層 (`src/server/`)

**mcp-server.ts**
- 使用 STDIO 傳輸初始化 MCP 伺服器
- 從環境和 CLI 參數載入配置
- 建立翻譯配置
- 註冊所有 MCP 工具
- 處理伺服器生命週期（啟動、停止、重新整理）

**mcp-tools.ts (MCPTools 類別)**
- 向伺服器註冊所有 7 個 MCP 工具
- 使用 Zod 定義工具架構以進行參數驗證
- 將工具呼叫路由到適當的處理器
- 提供動態配置更新的重新整理機制

#### 5.2.2 翻譯引擎 (`src/core/`)

**file-processor.ts**
- 使用 Babel 解析器解析原始檔案
- 遍歷 AST 以在以下位置尋找硬編碼文字：
  - `t()` 函數呼叫
  - `i18n.t()` 函數呼叫
  - `<Trans i18nKey="...">` JSX 元件
- 使用 Unicode 範圍偵測繁體中文文字
- 用 i18n 金鑰替換硬編碼文字
- 使用 Babel generator + Prettier 產生格式化的程式碼
- 返回重構的程式碼和偵測到的文字

**ai-service.ts**
- 整合 Google Gemini AI (gemini-1.5-flash 模型)
- 從硬編碼文字產生具有脈絡的 i18n 金鑰
- 將文字翻譯為所有已配置的目標語言
- 使用結構化 JSON 架構以實現可靠的解析
- 優雅地處理 API 失敗（返回模擬資料）
- 支援具有專案脈絡的自訂提示

**lang-manager.ts**
- 讀取和寫入語言 JSON 檔案
- 同時支援舊版和現代檔案結構
- 從現有檔案自動偵測檔案結構
- 將新翻譯與現有內容合併
- 保留檔案格式和金鑰順序
- 處理子目錄結構
- 原子檔案操作（暫存檔案 + 重新命名）

**language-discovery-service.ts**
- 掃描翻譯目錄中的現有 JSON 檔案
- 從檔案名稱或內容偵測語言代碼
- 從巢狀結構中提取語言資訊
- 返回已發現的語言及完整元資料
- 支援多種檔案命名慣例

**translation-config-service.ts**
- 從環境/CLI 建立翻譯配置
- 從多個來源合併配置（優先順序）：
  1. CLI 參數
  2. 環境變數
  3. 自動偵測
  4. 預設值
- 驗證配置完整性
- 為所有服務提供配置

#### 5.2.3 翻譯工具 (`src/tools/`)

**translate-file.ts**
```typescript
工具：translate-file
參數：
  - filePath: string (原始檔案路徑)
  - fileContent: string (原始碼內容)
流程：
  1. 使用 Babel 解析檔案
  2. 偵測硬編碼繁體中文文字
  3. 呼叫 AI 服務產生金鑰和翻譯
  4. 更新語言 JSON 檔案
  5. 在原始碼中用金鑰替換文字
  6. 使用 Prettier 格式化程式碼
  7. 返回重構的程式碼和摘要
```

**enhanced-translate-file.ts**
```typescript
工具：enhanced_translate_file
參數：
  - file_path: string
  - use_cache: boolean (預設：true)
  - force_refresh: boolean (預設：false)
  - cache_dir: string (預設：'.translation-cache')
  - progress_callback: boolean (預設：false)
  - batch_mode: boolean (預設：false)
功能：
  - 快取翻譯結果以避免重複的 AI 呼叫
  - 可配置的快取目錄
  - 強制重新整理以覆寫快取
  - 長時間操作的進度報告
```

**batch_translate_files** (同一檔案)
```typescript
工具：batch_translate_files
參數：
  - file_paths: string[] (可選，特定檔案)
  - src_dir: string (可選，要掃描的目錄)
  - file_patterns: string[] (預設：['**/*.{js,ts,jsx,tsx}'])
  - max_concurrency: number (預設：3)
  - cache_dir: string (預設：'.translation-cache')
  - use_cache: boolean (預設：true)
  - force_refresh: boolean (預設：false)
  - progress_updates: boolean (預設：true)
功能：
  - 可配置並行度的平行處理
  - 使用 glob 的檔案模式配對
  - 批次操作的進度更新
  - 跨檔案共享快取
```

#### 5.2.4 工作流程工具 (`src/tools/`)

**generate-locale-diff.ts**
```typescript
工具：generate_locale_diff
參數：
  - localeDir: string (語言環境目錄路徑)
  - projectRoot: string (可選，預設為 cwd)
  - baseBranch: string (可選，自動偵測 master/main)
  - mainLanguage: string (預設："zh-TW")
  - dryRun: boolean (預設：false)
  - autoCommit: boolean (預設：false)
  - commitMessage: string (可選，自動產生)
  - autoPush: boolean (預設：false)
  - pushBranch: string (可選，預設為目前分支)
流程：
  1. 偵測基礎分支 (master 或 main)
  2. 執行 git diff 以取得變更的檔案
  3. 對於每個子目錄 (例如：client/、editor/)：
     a. 解析目前和基礎分支的 JSON 檔案
     b. 識別新增、修改、刪除的金鑰
     c. 為所有語言產生差異 JSON
     d. 主語言顯示實際變更
     e. 其他語言顯示現有或空白
  4. 將差異檔案儲存到 locale/diff/ 目錄
  5. 可選地提交和推送變更
功能：
  - 在一次執行中支援多個子目錄
  - Git 整合以實現精確的變更偵測
  - 在差異輸出中保留結構
  - Dry-run 預覽模式
  - 整合的 git 工作流程
```

**merge-translations.ts**
```typescript
工具：merge_translations
參數：
  - originalDir: string (專案翻譯目錄)
  - reviewedDir: string (已審核翻譯目錄)
  - dryRun: boolean (預設：false)
  - verbose: boolean (預設：false)
  - projectRoot: string (可選)
  - cleanupDiffDirectory: boolean (預設：false)
  - autoCommit: boolean (預設：false)
  - commitMessage: string (可選)
  - autoPush: boolean (預設：false)
  - pushBranch: string (可選)
流程：
  1. 掃描 originalDir 尋找語言檔案
  2. 按語言代碼配對已審核檔案
  3. 對於每個配對：
     a. 載入原始和已審核的 JSON
     b. 識別新增、更新、未變更的金鑰
     c. 將變更合併到原始檔案
     d. 寫入更新的檔案 (dry-run：跳過寫入)
  4. 報告詳細統計資料
  5. 可選地清理差異目錄
  6. 可選地提交和推送
功能：
  - 按語言代碼智慧配對檔案
  - 選擇性更新（僅已變更的金鑰）
  - 詳細的變更報告
  - 安全的 dry-run 模式
  - 可選的自動清理
  - 整合的 git 工作流程
```

**cleanup-diff-directory.ts**
```typescript
工具：cleanup_diff_directory
參數：
  - diffDir: string (差異目錄路徑)
  - dryRun: boolean (預設：false)
  - projectRoot: string (可選)
流程：
  1. 解析 diffDir 路徑
  2. 檢查目錄是否存在
  3. 列出目錄中的所有檔案
  4. 移除所有檔案 (dry-run：跳過移除)
  5. 移除目錄本身
  6. 報告已移除的檔案
功能：
  - 具有錯誤處理的安全移除
  - 預覽模式 (dry-run)
  - 已移除檔案的詳細記錄
  - 優雅地處理缺少的目錄
```

#### 5.2.5 Git 整合工具 (`src/tools/`)

**git-commit-push.ts**
```typescript
工具：git_commit_push
參數：
  - files: string[] (可選，若未提供則使用已暫存的檔案)
  - commitMessage: string (可選，自動產生)
  - operationType: string (預設："i18n update")
  - operationDetails: string (可選)
  - push: boolean (預設：false)
  - branch: string (可選，自動偵測)
  - projectRoot: string (可選)
  - dryRun: boolean (預設：false)
流程：
  1. 解析 projectRoot
  2. 驗證 git 儲存庫
  3. 如果提供檔案：git add 檔案
  4. 如果未提供，則產生提交訊息
  5. 執行 git commit
  6. 如果 push：執行 git push
  7. 返回操作摘要
功能：
  - 選擇性或已暫存檔案的提交
  - 自動產生標準化訊息
  - 分支自動偵測
  - 整合的推送功能
  - Dry-run 預覽模式
  - 完整的錯誤處理
```

### 5.3 資料結構

#### TranslationConfig
```typescript
interface TranslationConfig {
  baseLanguage: LanguageInfo;      // 來源語言 (例如：zh-TW)
  targetLanguages: LanguageInfo[]; // 目標語言 (例如：en-US、ja)
  translationDir: string;          // 翻譯目錄路徑
  translationFile?: string;        // 特定翻譯檔案 (可選)
  translationSubdirectory?: string; // 子目錄 (可選)
  srcDir: string;                  // 原始碼目錄
  projectRoot: string;             // 專案根目錄
}
```

#### LanguageInfo
```typescript
interface LanguageInfo {
  code: string;              // 例如："en-US"
  localName: string;         // 例如："English"
  englishName: string;       // 例如："English"
  region?: string;           // 例如："United States"
  script?: string;           // 例如："Latin"
  direction?: 'ltr' | 'rtl'; // 文字方向
}
```

#### TranslationResult
```typescript
interface TranslationResult {
  [key: string]: {
    [languageCode: string]: string;
  };
}
// 範例：
// {
//   "result.display.timing": {
//     "zh-TW": "結果頁顯示時機",
//     "en-US": "Result page display timing",
//     "ja": "結果ページの表示タイミング"
//   }
// }
```

#### DiffGenerationResult
```typescript
interface DiffGenerationResult {
  success: boolean;
  message: string;
  baseBranch: string;
  currentBranch: string;
  diffDirectory: string;
  subdirectories: string[];
  processedSubdirectories: {
    name: string;
    languages: string[];
    statistics: {
      added: number;
      modified: number;
      deleted: number;
    };
  }[];
  committed?: boolean;
  pushed?: boolean;
}
```

#### MergeResult
```typescript
interface MergeResult {
  success: boolean;
  message: string;
  mergedFiles: {
    language: string;
    originalFile: string;
    reviewedFile: string;
    statistics: {
      newKeys: number;
      updatedKeys: number;
      unchangedKeys: number;
    };
  }[];
  cleanedUp?: boolean;
  committed?: boolean;
  pushed?: boolean;
}
```

### 5.4 API (MCP 工具架構)

所有工具都遵循 MCP 協定，使用 Zod 架構進行參數驗證。工具回應遵循此格式：

```typescript
interface ToolResponse {
  content: Array<{
    type: "text";
    text: string; // 主要回應內容（支援 Markdown）
  }>;
  isError?: boolean;
}
```

錯誤回應包括詳細的錯誤訊息和解決建議。

### 5.5 關鍵演算法

#### 硬編碼文字偵測演算法
```
1. 使用 Babel 解析器解析原始檔案
2. 使用訪問者模式遍歷 AST
3. 對於每個 CallExpression：
   - 如果 callee 是 't' 或 'i18n.t'
   - 檢查第一個參數
   - 如果是 StringLiteral 且包含繁體中文
   - 提取文字和位置
4. 對於每個 JSXElement：
   - 如果元件名稱是 'Trans'
   - 尋找 i18nKey 屬性
   - 如果值包含繁體中文
   - 提取文字和位置
5. 返回偵測到的文字陣列及其位置
```

#### Git Diff 解析演算法
```
1. 執行：git diff baseBranch..currentBranch -- localeDir
2. 逐行解析 diff 輸出
3. 對於以 '+' 開頭的行（新增）：
   - 解析 JSON 以提取新增/修改的金鑰
4. 對於以 '-' 開頭的行（刪除）：
   - 解析 JSON 以提取刪除的金鑰
5. 比較舊值和新值以識別修改
6. 按子目錄和語言分組變更
7. 產生保留結構的差異 JSON 檔案
```

#### 翻譯合併演算法
```
1. 載入原始翻譯 JSON
2. 載入已審核翻譯 JSON
3. 建立 merged 物件 = 原始物件的淺拷貝
4. 對於 reviewed 中的每個金鑰：
   - 如果金鑰不在 original 中：ADD (newKeys++)
   - 否則如果 original[key] != reviewed[key]：UPDATE (updatedKeys++)
   - 否則：UNCHANGED (unchangedKeys++)
   - 設定 merged[key] = reviewed[key]
5. 將 merged 物件寫入原始檔案
6. 返回統計資料
```

## 6. 測試策略

### 6.1 所需單元測試

#### 核心服務
- **file-processor.ts**
  - 解析有效的 JavaScript/TypeScript 檔案
  - 偵測 `t()` 呼叫中的繁體中文
  - 偵測 `<Trans>` 元件中的繁體中文
  - 正確地用 i18n 金鑰替換文字
  - 優雅地處理格式錯誤的原始檔案
  - 保留程式碼格式

- **ai-service.ts**
  - 產生具有脈絡的 i18n 金鑰
  - 翻譯為所有已配置的語言
  - 處理 API 失敗（回退至模擬）
  - 驗證回應架構
  - 處理速率限制

- **lang-manager.ts**
  - 讀取舊版檔案結構
  - 讀取現代檔案結構（每語言）
  - 讀取子目錄結構
  - 寫入翻譯而不損壞現有資料
  - 正確地自動偵測檔案結構
  - 處理檔案 I/O 錯誤

- **language-discovery-service.ts**
  - 從舊版檔案發現語言
  - 從現代檔案發現語言
  - 從子目錄發現語言
  - 處理空目錄
  - 處理格式錯誤的 JSON 檔案

#### 工具
- **translate-file**
  - 端到端翻譯工作流程
  - 處理沒有硬編碼文字的檔案
  - 處理具有多個文字的檔案
  - 更新正確的語言檔案
  - 返回格式正確的程式碼

- **generate-locale-diff**
  - 偵測 master vs main 分支
  - 正確解析 git diff 輸出
  - 識別新增/修改/刪除的金鑰
  - 產生正確的差異結構
  - 處理多個子目錄
  - 處理空差異（沒有變更）

- **merge-translations**
  - 按語言代碼配對檔案
  - 合併新金鑰
  - 更新已修改的金鑰
  - 保留未變更的金鑰
  - 正確計算統計資料
  - 處理不匹配的檔案結構

### 6.2 所需整合測試

- **完整翻譯工作流程**
  1. 從具有硬編碼文字的原始檔案開始
  2. 呼叫 translate-file 工具
  3. 驗證語言檔案已更新
  4. 驗證原始碼已重構
  5. 驗證程式碼仍然有效（可解析）

- **差異產生和合併工作流程**
  1. 建立包含語言環境變更的功能分支
  2. 呼叫 generate_locale_diff
  3. 驗證已建立具有正確結構的差異檔案
  4. 修改差異檔案（模擬利益相關者審核）
  5. 呼叫 merge_translations
  6. 驗證原始檔案已正確更新
  7. 呼叫 cleanup_diff_directory
  8. 驗證差異目錄已移除

- **Git 整合工作流程**
  1. 對翻譯檔案進行變更
  2. 使用特定檔案呼叫 git_commit_push
  3. 驗證已建立具有正確訊息的提交
  4. 驗證檔案已提交
  5. 啟用推送後呼叫 git_commit_push
  6. 驗證已推送至遠端

### 6.3 手動測試步驟

#### 設定測試環境
1. 複製具有現有 i18n 設定的測試專案
2. 使用測試專案路徑配置 MCP 伺服器
3. 準備包含硬編碼繁體中文的測試原始檔案

#### 測試 translate-file
1. 開啟 MCP Inspector：`npm run inspector`
2. 選擇 `translate-file` 工具
3. 輸入測試檔案路徑和內容
4. 驗證回應包括：
   - 具有 i18n 金鑰的重構程式碼
   - 偵測到的文字摘要
   - 已更新的語言檔案
5. 手動檢查語言 JSON 檔案
6. 驗證程式碼可以解析並執行

#### 測試 generate_locale_diff
1. 建立功能分支：`git checkout -b test-feature`
2. 修改語言環境檔案（新增、更新、刪除金鑰）
3. 提交變更
4. 透過 MCP Inspector 呼叫 `generate_locale_diff`
5. 驗證已建立差異目錄：`locale/diff/`
6. 驗證差異檔案包含正確的變更
7. 驗證子目錄已保留

#### 測試 merge_translations
1. 修改差異檔案（模擬審核）
2. 使用 dryRun=true 呼叫 `merge_translations`
3. 驗證預覽輸出顯示正確的統計資料
4. 使用 dryRun=false 呼叫 `merge_translations`
5. 驗證原始檔案已更新
6. 驗證差異目錄已清理（如果啟用）

#### 測試 git_commit_push
1. 暫存一些檔案：`git add locale/`
2. 使用 dryRun=true 呼叫 `git_commit_push`
3. 驗證預覽顯示正確的提交
4. 使用 dryRun=false 呼叫 `git_commit_push`
5. 驗證已建立提交：`git log`
6. 使用 push=true 呼叫
7. 驗證已推送：`git log --all`

#### 測試增強功能
1. 使用 use_cache=true 呼叫 `enhanced_translate_file`
2. 驗證已建立快取目錄：`.translation-cache/`
3. 使用相同檔案再次呼叫
4. 驗證使用快取（更快的回應）
5. 使用 src_dir 呼叫 `batch_translate_files`
6. 驗證已處理多個檔案
7. 驗證顯示進度更新

#### 測試邊界案例
1. 缺少 API 金鑰 → 應使用模擬資料
2. 格式錯誤的 JSON 檔案 → 應優雅地出錯
3. 不存在的檔案路徑 → 應清楚地出錯
4. 空的語言環境目錄 → 應建立檔案
5. 無效的 git 儲存庫 → 應清楚地出錯
6. 網路失敗 → 應重試或回退

#### 測試跨平台
1. 在 Windows、macOS、Linux 上測試
2. 驗證路徑解析正常運作
3. 驗證檔案操作正常
4. 驗證 git 操作正常

## 7. 文件更新

### 7.1 README.md 更新
✅ **已完成** - README.md 包括：
- 功能概述
- 安裝說明
- 配置指南（環境變數和 CLI 參數）
- 所有 7 個 MCP 工具及範例負載
- 開發和測試說明
- MCP Inspector 使用方式
- Claude Code 整合指南
- 除錯提示
- 範例測試檔案

### 7.2 CLAUDE.md 更新
✅ **已完成** - CLAUDE.md 包括：
- 專案概述
- 架構文件
- 核心元件說明
- 關鍵處理流程
- 配置詳細資訊
- 翻譯檔案管理（舊版和現代）
- 路徑解析策略
- 所有可用的 MCP 工具及參數
- 開發注意事項

### 7.3 程式碼註解
目前狀態：
- ✅ 核心服務有內聯文件
- ✅ 工具處理器有 JSDoc 註解
- ✅ 複雜演算法已說明
- ⚠️ 某些輔助函數可以使用更多註解

建議新增：
- 為所有匯出的函數新增 JSDoc 註解
- 記錄複雜的類型定義
- 在註解中為關鍵函數新增範例

### 7.4 所需的額外文件

#### 使用者指南（潛在未來）
- 首次使用者的逐步教學
- i18n 金鑰命名的最佳實務
- 翻譯審核工作流程指南
- 常見問題疑難排解

#### 開發人員指南（潛在未來）
- 貢獻指南 (CONTRIBUTING.md)
- 架構決策記錄 (ADRs)
- API 文件（從 JSDoc 產生）
- 測試指南

## 8. 風險與緩解

### 8.1 技術風險

#### 風險 1：AI 服務失敗
**影響**：高 - 核心功能依賴於 Google Gemini
**可能性**：中 - API 可能會有中斷或速率限制
**緩解**：
- ✅ 已實作：API 不可用時回退至模擬資料
- ✅ 已實作：具有詳細訊息的優雅錯誤處理
- 🔄 未來：支援多個 AI 提供者（OpenAI、Anthropic）
- 🔄 未來：實作指數退避重試邏輯

#### 風險 2：檔案損壞
**影響**：高 - 可能損壞正式環境翻譯檔案
**可能性**：低 - 但如果發生則是災難性的
**緩解**：
- ✅ 已實作：原子檔案操作（暫存檔案 + 重新命名）
- ✅ 已實作：所有破壞性操作的 dry-run 模式
- ✅ 已實作：寫入 JSON 前的驗證
- 🔄 未來：修改前的自動備份
- 🔄 未來：版本控制整合（變更前自動提交）

#### 風險 3：AST 解析失敗
**影響**：中 - 無法處理具有語法錯誤的檔案
**可能性**：中 - 使用者程式碼可能有語法錯誤
**緩解**：
- ✅ 已實作：Babel 解析器周圍的 try-catch
- ✅ 已實作：指示語法問題的清楚錯誤訊息
- 🔄 未來：建議在翻譯前使用 linter
- 🔄 未來：部分處理（跳過有問題的部分）

#### 風險 4：Git 操作失敗
**影響**：中 - 工作流程工具無法運作
**可能性**：低 - Git 通常很可靠
**緩解**：
- ✅ 已實作：完整的錯誤處理
- ✅ 已實作：預覽操作的 dry-run 模式
- ✅ 已實作：具有 git 輸出的清楚錯誤訊息
- 🔄 未來：操作前驗證 git 狀態
- 🔄 未來：自動衝突偵測和解決

### 8.2 可用性風險

#### 風險 5：複雜的配置
**影響**：中 - 使用者可能難以設定
**可能性**：中 - 許多配置選項
**緩解**：
- ✅ 已實作：自動偵測減少配置需求
- ✅ 已實作：所有選項的合理預設值
- ✅ 已實作：具有範例的詳細文件
- 🔄 未來：配置精靈/產生器
- 🔄 未來：驗證配置並建議修正

#### 風險 6：不清楚的錯誤訊息
**影響**：中 - 使用者遇到困難，無法除錯問題
**可能性**：低 - 已實作良好的錯誤處理
**緩解**：
- ✅ 已實作：具有脈絡的詳細錯誤訊息
- ✅ 已實作：常見問題的建議
- 🔄 未來：具有線上文件的錯誤代碼系統
- 🔄 未來：互動式疑難排解指南

### 8.3 效能風險

#### 風險 7：緩慢的 AI API 呼叫
**影響**：中 - 大型檔案的使用者體驗不佳
**可能性**：高 - API 呼叫本質上很慢
**緩解**：
- ✅ 已實作：增強工具中的快取系統
- ✅ 已實作：具有平行化的批次處理
- 🔄 未來：增量翻譯（僅新文字）
- 🔄 未來：本地 AI 模型選項（離線模式）

#### 風險 8：大型檔案處理
**影響**：中 - 記憶體問題，處理緩慢
**可能性**：低 - 大多數原始檔案大小合理
**緩解**：
- ✅ 已實作：盡可能使用串流處理
- ✅ 已實作：批次操作的並行限制
- 🔄 未來：檔案大小警告
- 🔄 未來：非常大檔案的分塊處理

### 8.4 相容性風險

#### 風險 9：相依性的重大變更
**影響**：高 - 伺服器可能停止運作
**可能性**：低 - 相依性已成熟
**緩解**：
- ✅ 已實作：固定的相依性版本
- ✅ 已實作：引擎需求 (Node.js >=22)
- 🔄 未來：具有測試的自動相依性更新
- 🔄 未來：向後相容性測試

#### 風險 10：MCP 協定變更
**影響**：高 - 伺服器與客戶端不相容
**可能性**：低 - MCP 相對穩定
**緩解**：
- ✅ 已實作：完全遵循 MCP SDK
- ✅ 已實作：使用最新的 MCP SDK 版本
- 🔄 未來：監控 MCP 協定更新
- 🔄 未來：版本相容性矩陣

---

## 總結

本規格文件記錄了包含 7 個主要工具的完整 i18n MCP 翻譯器系統，涵蓋：

1. **核心翻譯**：自動化 i18n 金鑰產生和多語言翻譯
2. **工作流程管理**：基於 Git 的差異產生、審核和合併工作流程
3. **Git 整合**：標準化的提交和推送操作
4. **增強功能**：快取、批次處理和最佳化

系統建立在以下基礎上：
- **MCP 協定**：用於 AI 助手整合的標準 STDIO 傳輸
- **Babel AST**：安全、精確的程式碼轉換
- **Google Gemini AI**：脈絡金鑰產生和翻譯
- **彈性檔案支援**：同時支援舊版和現代 i18n 檔案結構
- **Git 整合**：分支比較和自動化工作流程

所有功能均已實作並記錄，具有完整的錯誤處理、dry-run 模式和清楚的使用者回饋。

### 關鍵優勢
- ✅ 完全實作且功能正常
- ✅ 完整的文件（README、CLAUDE.md）
- ✅ 具有自動偵測的彈性配置
- ✅ 具有 dry-run 模式的安全操作
- ✅ 整合的 git 工作流程
- ✅ 支援多種檔案結構

### 未來增強的領域
- 🔄 多個 AI 提供者支援
- 🔄 增強的快取和效能最佳化
- 🔄 翻譯管理的 Web UI
- 🔄 開發期間的即時翻譯
- 🔄 翻譯記憶和術語表功能

---

**規格準備者：** Claude Code (AI 助手)
**日期：** 2025-11-05
**狀態：** 完成 - 所有功能已記錄
**下一步：** 使用 `/speckit-plan` 為未來的增強功能建立實作計劃
